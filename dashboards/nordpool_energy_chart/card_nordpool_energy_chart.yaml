# This code should be copy-pasted into a lovelace card.
# Requires the custom:config-template-card, custom:apexcharts-card, custom:nordpool-card and custom:congif-template-card to be installed. 

type: custom:config-template-card
variables:
  nordpool_sensor: '''sensor.nordpool'''
  grid_import_sensor: '''sensor.sigen_accumulated_grid_energy_import'''
  battery_soc_sensor: '''sensor.sigen_energy_storage_system_soc'''
  price_y_axis_unit: '''öre'''
  energy_y_axis_unit: '''kWh'''
  price_overview_unit: '''öre/kWh'''
  additional_cost_template: '''* 100 +5'''
  decimals_in_prices: 0
  decimals_in_energy: 1
  chart_price_cutoff_coerficient: 0.1
  chart_title: '''Electricity prices today'''
  total_purchease_price_text: '''Total purchease price'''
  grid_import_text: '''Grid Import'''
  battery_soc_text: '''Battery SOC'''
  lowest_price_text: '''Lowest to come'''
  highest_price_text: '''Highest to come'''
  price_now_text: '''Price now'''
  now_text: '''Now'''
  get_chart_cutoff: |
    (_min_price, _coefficient) => {
      if (_min_price <= 0) {
          return "auto";
      }
      return _min_price - (_min_price * _coefficient)
    }
  get_total_max_nordpool_price: |
    (_nordpool_sensor, _additional_cost_template) => {
      return states[_nordpool_sensor].attributes.raw_today.concat(states[_nordpool_sensor].attributes.raw_tomorrow).map(data=> eval("data.value"+_additional_cost_template)).reduce((a, b) => Math.max(a, b), -Infinity)
    }
  get_total_min_nordpool_price: |
    (_nordpool_sensor, _additional_cost_template) => {
      return states[_nordpool_sensor].attributes.raw_today.concat(states[_nordpool_sensor].attributes.raw_tomorrow).map(data=> eval("data.value"+_additional_cost_template)).reduce((a, b) => Math.min(a, b), Infinity)
    }
  get_low_bottom_threshold_nordpool_price: |
    (_min, _max) => {
      return parseFloat(_min) + parseFloat(((_max) - parseFloat(_max)) /10)
    }
  get_low_threshold_nordpool_price: |
    (_min, _max) => {
      return parseFloat(_min) + parseFloat(((_max) - parseFloat(_min)) /3)
    }
  get_high_threshold_nordpool_price: |
    (_min, _max) => {
      return parseFloat(_min) 
      + (( parseFloat(_max) - parseFloat(_min) ) /3) * 2
    }
  get_high_top_threshold_nordpool_price: |
    (_min, _max) => {
      return parseFloat(_min) + parseFloat(((_max) - parseFloat(_min)) /10)*9
    }
  get_total_prices: |
    cost_template => {
      return "return (entity.attributes.raw_today.map((start, index) => {return [new Date(start['start']).getTime(), entity.attributes.raw_today[index]['value']"
      + cost_template
      + "];})).concat(entity.attributes.raw_tomorrow.map((start, index) => {return [new Date(start['start']).getTime(),entity.attributes.raw_tomorrow[index]['value'] "
      + cost_template + "];}));"
    }
entities:
  - ${nordpool_sensor]
card:
  type: custom:apexcharts-card
  graph_span: >-
    ${ states[nordpool_sensor].attributes.raw_today.length +
    states[nordpool_sensor].attributes.raw_tomorrow.length + 'h' }
  yaxis:
    - id: y-price
      min: >-
        ${get_chart_cutoff(get_total_min_nordpool_price(nordpool_sensor,additional_cost_template),chart_price_cutoff_coerficient)}
      max: auto
      apex_config:
        opposite: false
        forceNiceScale: true
        decimalsInFloat: ${decimals_in_prices}
        labels:
          formatter: >
            ${"EVAL:function(value) {return value.toFixed("
            + decimals_in_prices
            + ") + ' " + price_y_axis_unit + "' }"
    - id: y-energy
      min: 0
      max: auto
      apex_config:
        opposite: true
        forceNiceScale: true
        decimalsInFloat: ${decimals_in_energy}
        labels:
          formatter: |
            ${"EVAL:function(value) {return value.toFixed("
            + decimals_in_energy
            + ") + ' " + energy_y_axis_unit + "' }"
    - id: y-SOC
      show: false
      min: 0
      max: 100
  apex_config:
    chart:
      height: 340px
    legend:
      show: false
    title:
      floating: false
      align: center
      style:
        fontSize: 20px
        fontWeight: bold
    xaxis:
      labels:
        datetimeFormatter:
          hour: HH:mm
  show:
    last_updated: true
  experimental:
    color_threshold: true
  header:
    title: ${chart_title}
    show: true
    show_states: true
    colorize_states: true
  span:
    start: day
  now:
    show: true
    label: ${now_text}
  series:
    - entity: ${nordpool_sensor}
      yaxis_id: y-price
      name: ${total_purchease_price_text}
      offset: '-30min'
      float_precision: ${decimals_in_prices}
      show:
        extremas: true
        in_header: false
        header_color_threshold: true
      type: column
      data_generator: ${get_total_prices(additional_cost_template)}
      color_threshold:
        - value: -1000
          color: '#00f738'
        - value: >-
            ${get_low_bottom_threshold_nordpool_price(get_total_min_nordpool_price(nordpool_sensor, additional_cost_template), get_total_max_nordpool_price(nordpool_sensor, additional_cost_template) )}
          color: '#28a745'
        - value: >-
            ${get_low_threshold_nordpool_price(get_total_min_nordpool_price(nordpool_sensor,additional_cost_template), get_total_max_nordpool_price(nordpool_sensor, additional_cost_template))}
          color: '#ffed4a'
        - value: >-
            ${get_high_threshold_nordpool_price(get_total_min_nordpool_price(nordpool_sensor,additional_cost_template), get_total_max_nordpool_price(nordpool_sensor, additional_cost_template))}
          color: '#fd7e14'
        - value: >-
            ${get_high_top_threshold_nordpool_price(get_total_min_nordpool_price(nordpool_sensor,additional_cost_template),get_total_max_nordpool_price(nordpool_sensor, additional_cost_template))}
          color: '#dc3545'
    - entity: ${grid_import_sensor}
      yaxis_id: y-energy
      name: ${grid_import_text}
      color: '#007bff'
      float_precision: ${decimals_in_energy}
      show:
        extremas: false
        in_header: true
        header_color_threshold: true
      type: area
      stroke_width: 1
      opacity: 0.2
      extend_to: false
      unit: ${energy_y_axis_unit}
      group_by:
        func: delta
        duration: 1h
    # - entity: ${battery_soc_sensor}
    #   yaxis_id: y-SOC
    #   name: ${battery_soc_text}
    #   color: '#6610f2 '
    #   float_precision: 0
    #   show:
    #     extremas: false
    #     in_header: true
    #     header_color_threshold: true
    #   type: area
    #   stroke_width: 1
    #   opacity: 0.4
    #   extend_to: false
    #   group_by:
    #     func: avg
    #     duration: 1h
    - entity: ${nordpool_sensor}
      color: '#00f738'
      float_precision: ${decimals_in_prices}
      stroke_width: 2
      name: ${lowest_price_text}
      unit: ${price_overview_unit}
      show:
        in_chart: false
        legend_value: false
      group_by:
        func: min
        duration: 2d
      data_generator: ${get_total_prices(additional_cost_template)}
    - entity: ${nordpool_sensor}
      name: ${price_now_text}
      color: orange
      type: column
      unit: ${price_overview_unit}
      show:
        in_chart: false
      float_precision: ${decimals_in_prices}
      data_generator: ${get_total_prices(additional_cost_template)}
    - entity: ${nordpool_sensor}
      type: column
      color: '#dc3545'
      float_precision: ${decimals_in_prices}
      stroke_width: 2
      name: ${highest_price_text}
      unit: ${price_overview_unit}
      show:
        in_chart: false
        legend_value: false
      group_by:
        func: max
        duration: 2d
      data_generator: ${get_total_prices(additional_cost_template)}
layout_options:
  grid_columns: full

# Home Assistant Nordpool Energy Chart helpers
# https://github.com/TypQxQ/Sigenergy-Inverter-Modbus-Home-Assistant
# by Andrei Ignat (TypQxQ)
# last update: 2024-09-26
#
# Note: This YAML is only tested with Home Assistant >= 2024.9
##############################################################################################


input_number:
  total_nordpool_hours_available:
    name: Total Nordpool Hours Available
    min: 0
    max: 48
    step: 1
    mode: box
    icon: mdi:clock-time-four-outline

  total_average_nordpool_price:
    name: Total Average Nordpool Price
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  total_max_nordpool_price:
    name: Total Max Nordpool Price
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  total_min_nordpool_price:
    name: Total Min Nordpool Price
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  low_threshold_nordpool_price:
    name: Low Threshold Nordpool Price
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  low_threshold_nordpool_price_bottom:
    name: Low Threshold Nordpool Price Bottom
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  high_threshold_nordpool_price:
    name: High Threshold Nordpool Price
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur

  high_threshold_nordpool_price_top:
    name: High Threshold Nordpool Price Top
    min: 0
    max: 100000
    step: 0.01
    mode: box
    icon: mdi:currency-eur
    

  

automation:
  - id: total_nordpool_hours_available
    alias: Total Nordpool Hours Available
    description: ""
    trigger:
      - platform: time_pattern
        seconds: "50"
    condition: []
    mode: single
    action:
      - service: input_number.set_value
        metadata: {}
        data:
          value: >-
            {{ (((state_attr('sensor.nordpool', 'raw_today') |
            map(attribute='value') | list) +
            (state_attr('sensor.nordpool', 'raw_tomorrow') |
            map(attribute='value') | list)) | list | length ) }}
        target:
          entity_id: input_number.total_nordpool_hours_available
      - service: input_number.set_value
        metadata: {}
        data:
          value: >-
            {{ (((state_attr('sensor.nordpool', 'raw_today') |
            map(attribute='value') | list) +
            (state_attr('sensor.nordpool', 'raw_tomorrow') |
            map(attribute='value') | list)) | list | sum / (((state_attr('sensor.nordpool', 'raw_today') |
            map(attribute='value') | list) +
            (state_attr('sensor.nordpool', 'raw_tomorrow') |
            map(attribute='value') | list)) | list | length)) | round(2) }}
        target: 
          entity_id: input_number.total_average_nordpool_price
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.total_max_nordpool_price
        data:
          value: >-
            {{ (((state_attr('sensor.nordpool', 'raw_today') |
            map(attribute='value') | list) +
            (state_attr('sensor.nordpool', 'raw_tomorrow') |
            map(attribute='value') | list)) | list | max | round(2)) }}
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.total_min_nordpool_price
        data:
          value: >-
            {{ (((state_attr('sensor.nordpool', 'raw_today') |
            map(attribute='value') | list) +
            (state_attr('sensor.nordpool', 'raw_tomorrow') |
            map(attribute='value') | list)) | list | min | round(2)) }}
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.low_threshold_nordpool_price
        data:
          value: >-
            {{ (states('input_number.total_min_nordpool_price') | float
                + (states('input_number.total_max_nordpool_price') | float
                  - states('input_number.total_min_nordpool_price') | float
                  ) / 3
                ) | round(2) 
              }}
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.low_threshold_nordpool_price_bottom
        data:
          value: >-
            {{ (states('input_number.total_min_nordpool_price') | float
              + 1 * (states('input_number.total_max_nordpool_price') | float
                - states('input_number.total_min_nordpool_price') | float
                ) / 10
              ) | round(2) 
            }}
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.high_threshold_nordpool_price
        data:
          value: >-
            {{ (states('input_number.total_min_nordpool_price') | float
                + 2 * (states('input_number.total_max_nordpool_price') | float
                  - states('input_number.total_min_nordpool_price') | float
                  ) / 3
                ) | round(2) 
              }}
      - service: input_number.set_value
        metadata: {}
        target: 
          entity_id: input_number.high_threshold_nordpool_price_top
        data:
          value: >-
            {{ (states('input_number.total_min_nordpool_price') | float
              + 9 * (states('input_number.total_max_nordpool_price') | float
                - states('input_number.total_min_nordpool_price') | float
                ) / 10
              ) | round(2) 
            }}
